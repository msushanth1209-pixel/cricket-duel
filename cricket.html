<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricket Duel: Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#121212; --text:#fff; --gold:#ffd700; --red:#d32f2f; --blue:#1976d2; --green:#2e7d32; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* TYPOGRAPHY */
        h1, h2, .font-teko { font-family: 'Teko', sans-serif; text-transform: uppercase; letter-spacing: 1px; line-height: 1; }
        
        /* SCREENS */
        .screen { display: none; width: 100%; max-width: 500px; height: 100%; flex-direction: column; position: relative; z-index: 10; }
        .screen.active { display: flex; }
        
        /* UI ELEMENTS */
        .btn { border: none; padding: 12px; font-family: 'Teko'; font-size: 1.4rem; cursor: pointer; text-transform: uppercase; margin: 5px; border-radius: 4px; width: 90%; max-width: 300px; align-self: center; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-outline { background: transparent; border: 2px solid #444; color: #aaa; }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        
        .input-box { background: #222; border: 1px solid #444; color: white; padding: 10px; width: 90%; text-align: center; font-size: 1.2rem; margin: 10px 0; }
        
        /* HEADER BAR */
        .top-bar { width: 100%; background: #1a1a1a; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); }
        
        /* PLAYER LISTS */
        .team-box { flex: 1; padding: 10px; overflow-y: auto; }
        .p-row { padding: 8px; margin: 4px 0; background: #222; border-left: 4px solid #555; cursor: pointer; display: flex; justify-content: space-between; }
        .border-red { border-color: var(--red); }
        .border-blue { border-color: var(--blue); }
        
        /* GAMEPLAY */
        .pitch { flex: 1; width: 100%; background: var(--green); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .card-slot { width: 100px; height: 140px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin: 10px; background: rgba(0,0,0,0.1); }
        .card { width: 100px; height: 140px; background: white; color: black; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Teko'; font-size: 2rem; border: 4px solid #333; animation: pop 0.3s; }
        
        @keyframes pop { from{transform:scale(0);} to{transform:scale(1);} }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="font-teko" style="font-size:1.5rem;" id="main-status">LOBBY</div>
        <div class="font-teko" style="font-size:1.5rem; color:var(--gold);" id="main-timer">--</div>
    </div>

    <div id="s-home" class="screen active" style="justify-content:center;">
        <h1 style="font-size:4rem; color:var(--gold); text-align:center;">CRICKET DUEL</h1>
        <input type="text" id="my-name" class="input-box" placeholder="YOUR NAME" maxlength="12">
        <button class="btn btn-gold" onclick="hostGame()">HOST MATCH</button>
        <div style="display:flex; justify-content:center; width:90%; gap:5px;">
            <input type="text" id="join-code" class="input-box" placeholder="ROOM CODE" style="margin:0;">
            <button class="btn btn-outline" style="margin:0; width:auto;" onclick="joinGame()">JOIN</button>
        </div>
    </div>

    <div id="s-lobby" class="screen">
        <div style="text-align:center; padding:10px;">ROOM CODE: <span id="disp-code" style="color:var(--gold); font-size:2rem;">...</span></div>
        <div style="display:flex; height:100%;">
            <div class="team-box" id="list-red"></div>
            <div class="team-box" id="list-blue"></div>
        </div>
        <div id="host-controls" style="padding:20px; display:none; flex-direction:column;">
            <p style="text-align:center; color:#777; font-size:0.9rem;">Tap names to swap teams</p>
            <button class="btn btn-gold" onclick="startGame()">START GAME</button>
        </div>
        <div id="msg-wait" style="text-align:center; padding:20px; color:#777;">Waiting for Host...</div>
    </div>

    <div id="s-voting" class="screen">
        <h2 style="text-align:center; margin-top:20px;">VOTE CAPTAIN</h2>
        <div id="vote-container" style="padding:20px; overflow-y:auto;"></div>
    </div>

    <div id="s-naming" class="screen" style="justify-content:center; align-items:center;">
        <h2>NAME YOUR TEAM</h2>
        <input type="text" id="team-name-in" class="input-box" placeholder="TEAM NAME">
        <button class="btn btn-gold" onclick="submitName()">SUBMIT</button>
        <p id="naming-wait" style="display:none; color:#777;">Waiting for Captains...</p>
    </div>

    <div id="s-toss" class="screen" style="justify-content:center; align-items:center;">
        <h1 style="font-size:3rem;" id="toss-res">TOSS...</h1>
        <div id="toss-btns" style="display:none;">
            <p style="color:var(--gold);">YOU WON! CHOOSE:</p>
            <button class="btn btn-blue" onclick="pickToss('BAT')">BAT</button>
            <button class="btn btn-red" onclick="pickToss('BOWL')">BOWL</button>
        </div>
    </div>

    <div id="s-game" class="screen">
        <div class="top-bar" style="font-size:1.2rem;">
            <span id="score-txt">0/0</span>
            <span id="overs-txt">0.0</span>
        </div>
        <div class="pitch">
            <div id="slot-opp" class="card-slot">OPP</div>
            <div id="slot-me" class="card-slot">ME</div>
            <div id="res-popup" style="position:absolute; font-size:4rem; font-family:'Teko'; display:none; text-shadow:0 0 10px black;">OUT!</div>
        </div>
        <div id="hand-box" style="padding:10px; display:flex; gap:10px; overflow-x:auto; background:#222;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC--gCjpWdYsezrqvQ4tAzvtLKGW_oRtsM",
            authDomain: "cricketduel.firebaseapp.com",
            databaseURL: "https://cricketduel-default-rtdb.firebaseio.com/",
            projectId: "cricketduel",
            storageBucket: "cricketduel.firebasestorage.app",
            messagingSenderId: "781919289708",
            appId: "1:781919289708:web:3c6076617f4b7813757349"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- VARS ---
        let myName = "", roomCode = "", isHost = false, myTeam = "A";
        let stateData = {}; 
        let timerInt = null;

        const CARDS = {
            BAT: ['6 RUNS', '4 RUNS', '4 RUNS', '2 RUNS', '2 RUNS', '1 RUN', '1 RUN', 'DEFENSE'],
            BOWL: ['YORKER', 'BOUNCER', 'FAST', 'FAST', 'SPIN', 'SPIN', 'FULL TOSS', 'FULL TOSS']
        };
        const MATRIX = {
            '6 RUNS': { 'FULL TOSS':6, 'SPIN':6, 'FAST':-1, 'YORKER':-1, 'BOUNCER':0 },
            '4 RUNS': { 'FULL TOSS':4, 'BOUNCER':4, 'FAST':-1, 'YORKER':-1, 'SPIN':0 },
            '2 RUNS': { 'SPIN':2, 'FAST':2, 'BOUNCER':-1, 'YORKER':-1, 'FULL TOSS':0 },
            '1 RUN':  { 'FAST':1, 'YORKER':1, 'SPIN':-1, 'BOUNCER':-1, 'FULL TOSS':0 },
            'DEFENSE':{ 'FAST':0, 'YORKER':0, 'FULL TOSS':-1, 'SPIN':0, 'BOUNCER':0 }
        };

        // --- HELPERS ---
        const $ = id => document.getElementById(id);
        const show = id => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }

        // --- SETUP ---
        window.hostGame = async () => {
            myName = $('my-name').value.toUpperCase();
            if(!myName) return alert("Name required");
            roomCode = Math.random().toString(36).substring(2,6).toUpperCase();
            isHost = true;
            await set(ref(db, 'rooms/'+roomCode), {
                state: 'LOBBY',
                players: { [myName]: { team:'A', hand:[] } },
                teams: { A:{name:'RED'}, B:{name:'BLUE'} },
                timer: 0
            });
            init();
        };

        window.joinGame = async () => {
            myName = $('my-name').value.toUpperCase();
            roomCode = $('join-code').value.toUpperCase();
            if(!myName || !roomCode) return alert("Info required");
            const snap = await get(ref(db, 'rooms/'+roomCode));
            if(!snap.exists()) return alert("Room not found");
            const pCount = Object.keys(snap.val().players || {}).length;
            await update(ref(db, `rooms/${roomCode}/players/${myName}`), { team: pCount%2===0?'A':'B' });
            init();
        };

        function init() {
            $('disp-code').innerText = roomCode;
            onValue(ref(db, 'rooms/'+roomCode), snap => {
                stateData = snap.val();
                if(stateData) render(stateData);
            });
            if(isHost) setInterval(hostLoop, 1000); // THE ACTIVE HOST LOOP
        }

        // --- THE ACTIVE HOST LOOP (THE FIX) ---
        function hostLoop() {
            if(!stateData || !stateData.timer) return;
            const now = Math.floor(Date.now()/1000);
            const left = stateData.timer - now;
            
            // Auto-advance if time is up
            if(left <= 0) {
                if(stateData.state === 'VOTING') finalizeVoting();
                else if(stateData.state === 'NAMING') forceNext('TOSS');
                else if(stateData.state === 'TOSS') {
                    // Random pick if stuck
                    if(!stateData.tossWinner) update(ref(db, `rooms/${roomCode}/tossWinner`), Math.random()>0.5?'A':'B');
                    else forceNext('GAME'); // Default to Bat if timed out
                }
                else if(stateData.state === 'GAME') resolveTurn(); 
            }
        }

        // --- RENDER & LOGIC ---
        function render(data) {
            // Update Timer UI
            const left = Math.max(0, data.timer - Math.floor(Date.now()/1000));
            $('main-timer').innerText = left > 0 ? left : '--';
            $('main-status').innerText = data.state;

            // Update My Team
            if(data.players && data.players[myName]) myTeam = data.players[myName].team;

            // Render Screens
            if(data.state === 'LOBBY') renderLobby(data);
            else if(data.state === 'VOTING') renderVoting(data);
            else if(data.state === 'NAMING') renderNaming(data);
            else if(data.state === 'TOSS') renderToss(data);
            else if(data.state === 'GAME') renderGame(data);
        }

        // --- LOBBY ---
        function renderLobby(data) {
            show('s-lobby');
            $('list-red').innerHTML = ''; $('list-blue').innerHTML = '';
            
            Object.keys(data.players || {}).forEach(p => {
                const tm = data.players[p].team;
                const div = document.createElement('div');
                div.className = `p-row ${tm==='A'?'border-red':'border-blue'}`;
                div.innerText = p;
                if(isHost) div.onclick = () => update(ref(db, `rooms/${roomCode}/players/${p}/team`), tm==='A'?'B':'A');
                (tm==='A' ? $('list-red') : $('list-blue')).appendChild(div);
            });

            if(isHost) { $('host-controls').style.display = 'flex'; $('msg-wait').style.display = 'none'; }
        }

        window.startGame = () => update(ref(db, 'rooms/'+roomCode), { state: 'VOTING', timer: Math.floor(Date.now()/1000) + 30 });

        // --- VOTING ---
        function renderVoting(data) {
            show('s-voting');
            const box = $('vote-container');
            box.innerHTML = '';
            
            Object.keys(data.players).forEach(p => {
                if(data.players[p].team === myTeam) {
                    const btn = document.createElement('button');
                    btn.className = "btn btn-outline";
                    btn.innerText = `VOTE ${p}`;
                    // Highlight if I voted
                    if(data.votes && data.votes[myTeam] && data.votes[myTeam][myName] === p) {
                        btn.className = "btn btn-gold";
                    }
                    btn.onclick = () => update(ref(db, `rooms/${roomCode}/votes/${myTeam}/${myName}`), p);
                    box.appendChild(btn);
                }
            });
        }

        function finalizeVoting() {
            // Host counts votes
            const getCap = (team) => {
                // Simply pick first player if no votes, logic can be better but this is safe
                const ks = Object.keys(stateData.players).filter(k=>stateData.players[k].team === team);
                return ks[Math.floor(Math.random()*ks.length)];
            };
            update(ref(db, 'rooms/'+roomCode), {
                state: 'NAMING',
                'teams/A/captain': getCap('A'),
                'teams/B/captain': getCap('B'),
                timer: Math.floor(Date.now()/1000) + 30
            });
        }

        // --- NAMING ---
        function renderNaming(data) {
            show('s-naming');
            const isCap = data.teams[myTeam].captain === myName;
            
            if(isCap) {
                $('team-name-in').style.display = 'block';
                $('naming-wait').style.display = 'none';
            } else {
                $('team-name-in').style.display = 'none';
                $('naming-wait').style.display = 'block';
            }

            // Check if both named (Instant Progress)
            if(isHost && data.teams.A.named && data.teams.B.named) forceNext('TOSS');
        }

        window.submitName = () => {
            const n = $('team-name-in').value.toUpperCase();
            if(!n) return;
            update(ref(db, `rooms/${roomCode}/teams/${myTeam}`), { name: n, named: true });
        };

        // --- TOSS ---
        function renderToss(data) {
            show('s-toss');
            
            // Host logic: Pick winner if not exists
            if(isHost && !data.tossWinner) {
                update(ref(db, `rooms/${roomCode}/tossWinner`), Math.random()>0.5?'A':'B');
            }

            if(data.tossWinner) {
                const winName = data.teams[data.tossWinner].name || "TEAM "+data.tossWinner;
                $('toss-res').innerText = winName + " WON TOSS";
                
                const iAmCap = data.teams[myTeam].captain === myName;
                if(iAmCap && myTeam === data.tossWinner) $('toss-btns').style.display = 'block';
                else $('toss-btns').style.display = 'none';
            }
        }

        window.pickToss = (choice) => {
            const winner = stateData.tossWinner;
            const bat = choice==='BAT' ? winner : (winner==='A'?'B':'A');
            const bowl = bat==='A'?'B':'A';
            
            update(ref(db, 'rooms/'+roomCode), {
                state: 'GAME',
                batTeam: bat,
                bowlTeam: bowl,
                score: {r:0, w:0, b:0},
                timer: Math.floor(Date.now()/1000) + 9999 // Game loops handle their own timing
            });
        };

        // --- GAME (Simplified for reliability) ---
        function renderGame(data) {
            show('s-game');
            $('score-txt').innerText = `${data.score.r}/${data.score.w}`;
            $('overs-txt').innerText = `${Math.floor(data.score.b/6)}.${data.score.b%6}`;

            // Hand
            const handBox = $('hand-box');
            handBox.innerHTML = '';
            
            // Show Cards logic
            const isBatting = data.batTeam === myTeam;
            const myCards = CARDS[isBatting ? 'BAT' : 'BOWL'];
            
            myCards.forEach(c => {
                const d = document.createElement('div');
                d.className = "card"; 
                d.style.fontSize = "1rem";
                d.innerText = c;
                d.onclick = () => playCard(c, isBatting);
                handBox.appendChild(d);
            });

            // Show Slots
            if(data.turn) {
                if(data.turn.bat) $('slot-me').innerText = "LOCKED";
                if(data.turn.res) {
                    $('res-popup').style.display = 'block';
                    $('res-popup').innerText = data.turn.res;
                    setTimeout(()=>$('res-popup').style.display='none', 2000);
                }
            }
        }

        window.playCard = (c, isBat) => {
            const key = isBat ? 'bat' : 'bowl';
            update(ref(db, `rooms/${roomCode}/turn/${key}`), c);
            if(isHost) setTimeout(checkTurn, 500);
        };

        function checkTurn() {
            const t = stateData.turn;
            if(t && t.bat && t.bowl && !t.res) {
                // Calc result
                const res = MATRIX[t.bat][t.bowl];
                let txt = "";
                let sc = stateData.score;
                
                if(res === -1) { sc.w++; txt="OUT!"; }
                else { sc.r += res; txt=res+" RUNS"; }
                sc.b++;

                update(ref(db, `rooms/${roomCode}`), {
                    score: sc,
                    'turn/res': txt,
                    'turn/bat': null, // Reset for next
                    'turn/bowl': null
                });
            }
        }

        function forceNext(st) {
            update(ref(db, `rooms/${roomCode}/state`), st);
            update(ref(db, `rooms/${roomCode}/timer`), Math.floor(Date.now()/1000) + 30);
        }

    </script>
</body>
</html>