<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricket Duel</title>
    <style>
        /* --- 1. VISUAL THEME --- */
        :root {
            --pitch-green: #27ae60;
            --pitch-light: #2ecc71;
            --night-sky: #1e272e;
            --card-white: #f5f6fa;
            --csk-yellow: #f1c40f;
            --mi-blue: #3498db;
            --danger-red: #e74c3c;
            --text-main: #ecf0f1;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--night-sky);
            color: var(--text-main);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none; /* Prevents text selection on taps */
        }

        /* --- 2. HEADER (Fixed) --- */
        header {
            height: 60px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            z-index: 20;
        }

        /* --- 3. MAIN (Scrollable) --- */
        main {
            flex: 1;
            overflow-y: auto;
            position: relative;
            background: radial-gradient(circle at center, #2c3e50 0%, #1e272e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            z-index: 1;
        }

        /* --- 4. FOOTER (Fixed) --- */
        footer {
            height: 100px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            padding: 0 10px;
            overflow-x: auto;
            white-space: nowrap;
            flex-shrink: 0;
            z-index: 20;
        }

        /* --- UI COMPONENTS --- */
        h1, h2, h3 { margin: 0 0 10px 0; text-align: center; text-transform: uppercase; letter-spacing: 1px; }

        .btn {
            background: linear-gradient(135deg, var(--pitch-light), var(--pitch-green));
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            text-transform: uppercase;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-red), #c0392b); box-shadow: none; }
        .btn-blue { background: linear-gradient(135deg, var(--mi-blue), #2980b9); box-shadow: none; }
        .btn-icon { padding: 8px 12px; font-size: 1.2rem; background: rgba(255,255,255,0.1); margin-left: 5px; }

        /* Small Buttons for Host Actions */
        .btn-mini { 
            padding: 4px 8px; 
            font-size: 0.7rem; 
            margin-left: 6px; 
            border-radius: 6px;
            box-shadow: none;
        }

        .card-btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-width: 85px;
            height: 70px;
            margin-right: 10px;
            background: var(--card-white);
            color: var(--night-sky);
            border-radius: 8px;
            border: none;
            font-weight: 900;
            font-size: 0.8rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            white-space: normal;
            text-align: center;
            cursor: pointer;
            line-height: 1.1;
        }
        .card-btn:active { transform: scale(0.9); background: #dfe4ea; }

        .screen { display: none; width: 100%; max-width: 500px; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* LOBBY */
        .team-box { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; margin: 15px 0; border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .player-item { 
            padding: 10px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .host-actions { display: flex; align-items: center; }

        /* GAMEPLAY */
        .scoreboard {
            background: #000; color: #0f0; font-family: 'Courier New', monospace;
            padding: 15px; border-radius: 8px; border: 2px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0,255,0,0.1);
        }
        .pitch-area {
            display: flex; justify-content: space-between; margin: 20px 0; perspective: 800px;
        }
        .slot {
            width: 130px; height: 180px;
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: rgba(255,255,255,0.4);
            transition: all 0.5s;
        }
        .slot.ready { border-color: var(--csk-yellow); background: rgba(241, 196, 15, 0.1); color: var(--csk-yellow); }
        .slot.revealed { 
            background: var(--card-white); color: var(--night-sky); 
            border: 4px solid var(--pitch-light); transform: rotateY(0deg); 
            font-weight: 900; font-size: 1.2rem;
        }

        #coin {
            width: 100px; height: 100px; border-radius: 50%; background: gold; border: 5px solid #d4ac0d;
            margin: 20px auto; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: #7f6000; font-weight: 900;
        }
        .spinning { animation: flip 0.6s infinite linear; }
        @keyframes flip { 0% { transform: rotateX(0); } 100% { transform: rotateX(360deg); } }

        /* MODALS */
        .overlay-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .rules-table { width: 100%; max-width: 500px; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: 0.8rem; }
        .rules-table th, .rules-table td { border: 1px solid #555; padding: 8px; text-align: left; }
        .rules-table th { background: #333; color: var(--csk-yellow); }

    </style>
</head>
<body>

    <header>
        <div style="font-weight:900; font-size:1.1rem; color:var(--pitch-light);">CRICKET DUEL</div>
        <div style="display:flex; align-items:center;">
            <button class="btn btn-icon" onclick="document.getElementById('rules-overlay').style.display='flex'">?</button>
            <button class="btn btn-icon btn-danger" onclick="window.location.reload()" style="font-size:0.8rem; font-weight:bold;">EXIT</button>
            <button id="force-btn" class="btn btn-danger btn-mini" style="display:none; margin-left:10px;">FORCE ‚è©</button>
        </div>
    </header>

    <main>
        <div id="screen-login" class="screen active">
            <h1>Stadium Entry</h1>
            <input type="text" id="inp-room" placeholder="Room Code (e.g. IPL)" style="width:100%; padding:15px; margin:10px 0; border-radius:10px; border:none; box-sizing:border-box;">
            <input type="text" id="inp-name" placeholder="Your Name" style="width:100%; padding:15px; margin:10px 0; border-radius:10px; border:none; box-sizing:border-box;">
            <button class="btn" style="width:100%; margin-top:10px;" onclick="app.join()">JOIN MATCH</button>
        </div>

        <div id="screen-lobby" class="screen">
            <h2>Room: <span id="lobby-code" style="color:var(--pitch-light)"></span></h2>
            <div id="host-badge" style="display:none; text-align:center; color:gold; margin-bottom:10px;">‚≠ê YOU ARE THE HOST ‚≠ê</div>
            
            <div class="team-box" style="border-left: 5px solid var(--danger-red);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="color:var(--danger-red); margin:0;">RED TEAM</h3>
                    <div id="cap-a-name" style="color:gold; font-size:0.8rem;"></div>
                </div>
                <div id="list-a" style="margin-top:10px;"></div>
            </div>

            <div class="team-box" style="border-left: 5px solid var(--mi-blue);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="color:var(--mi-blue); margin:0;">BLUE TEAM</h3>
                    <div id="cap-b-name" style="color:gold; font-size:0.8rem;"></div>
                </div>
                <div id="list-b" style="margin-top:10px;"></div>
            </div>

            <div id="host-controls" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:15px;">
                <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" onclick="app.hostShuffle()">üîÄ SHUFFLE TEAMS</button>
                <button class="btn" style="width:100%" onclick="app.hostStart()">START MATCH</button>
            </div>
            <p id="lobby-msg" style="text-align:center; color:#7f8c8d; margin-top:10px;">Waiting for players...</p>
        </div>

        <div id="screen-naming" class="screen">
            <h2>Team Name</h2>
            <div id="naming-ui" style="display:none;">
                <input type="text" id="inp-teamname" placeholder="Enter Team Name" style="width:100%; padding:15px; border-radius:10px; border:none; margin-bottom:15px; box-sizing:border-box;">
                <button class="btn" style="width:100%" onclick="app.submitName()">CONFIRM</button>
            </div>
            <p id="naming-msg" style="text-align:center; color:#95a5a6;"></p>
        </div>

        <div id="screen-toss" class="screen" style="text-align:center;">
            <h2>The Toss</h2>
            <div id="coin">?</div>
            <div id="toss-ui" style="margin-top:20px;"></div>
            <p id="toss-msg" style="margin-top:20px; font-weight:bold;"></p>
        </div>

        <div id="screen-selection" class="screen">
            <h2>Strategy</h2>
            <h3 id="sel-title" style="color:var(--pitch-light); font-size:0.9rem; margin-bottom:15px;"></h3>
            <div id="sel-list" class="team-box"></div>
            <p id="sel-msg" style="text-align:center; color:#95a5a6;"></p>
        </div>

        <div id="screen-game" class="screen">
            <div class="scoreboard">
                <div>
                    <div style="font-size:0.7rem; color:#888;">BAT</div>
                    <div id="sb-bat" style="font-weight:bold;">--</div>
                </div>
                <div style="text-align:center;">
                    <div id="sb-score" style="font-size:1.5rem; color:#fff;">0/0</div>
                    <div style="font-size:0.7rem; color:#888;">TARGET: <span id="sb-target">--</span></div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.7rem; color:#888;">BOWL</div>
                    <div id="sb-bowl" style="font-weight:bold;">--</div>
                </div>
            </div>
            <div style="text-align:center;">
                <span style="background:#333; padding:4px 8px; border-radius:4px; font-size:0.8rem;">OVERS: <span id="sb-overs">0.0</span></span>
            </div>

            <div class="pitch-area">
                <div id="slot-opp" class="slot">
                    <span style="font-size:2rem;">?</span>
                    <span>OPPONENT</span>
                </div>
                <div id="slot-me" class="slot">
                    <span style="font-size:2rem;">...</span>
                    <span>YOU</span>
                </div>
            </div>
            <p id="game-msg" style="text-align:center; color:var(--csk-yellow); font-weight:bold;">Make your move!</p>
        </div>
    </main>

    <footer id="foot-hand"></footer>

    <div id="result-overlay" class="overlay-modal">
        <div id="res-text" style="font-size:4rem; font-weight:900; color:var(--csk-yellow); margin-bottom:10px;">OUT!</div>
        <div id="res-desc" style="font-size:1.2rem; color:#bdc3c7; margin-bottom:30px;">Clean Bowled</div>
        <button class="btn" onclick="app.closeOverlay()">NEXT BALL</button>
    </div>

    <div id="rules-overlay" class="overlay-modal" style="display:none; justify-content:flex-start; padding-top:60px;">
        <h2 style="color:var(--csk-yellow);">GAME RULES</h2>
        <p style="text-align:center; color:#ccc; font-size:0.9rem;">Predict your opponent's move to score or take wickets.</p>
        <table class="rules-table">
            <thead><tr><th>BAT CARD</th><th>VS BOWLER CARD</th><th>RESULT</th></tr></thead>
            <tbody>
                <tr><td>6 RUNS</td><td>Fast / Yorker</td><td>OUT</td></tr>
                <tr><td>6 RUNS</td><td>Spin / Full Toss</td><td>6 Runs</td></tr>
                <tr><td>4 RUNS</td><td>Fast / Yorker</td><td>OUT</td></tr>
                <tr><td>4 RUNS</td><td>Bouncer / Full Toss</td><td>4 Runs</td></tr>
                <tr><td>2 RUNS</td><td>Bouncer / Yorker</td><td>OUT</td></tr>
                <tr><td>1 RUN</td><td>Spin / Bouncer</td><td>OUT</td></tr>
                <tr><td>DEFENSE</td><td>Full Toss</td><td>OUT</td></tr>
                <tr><td>DEFENSE</td><td>Any Other</td><td>0 Runs</td></tr>
            </tbody>
        </table>
        <button class="btn" style="margin-top:20px;" onclick="document.getElementById('rules-overlay').style.display='none'">CLOSE</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC--gCjpWdYsezrqvQ4tAzvtLKGW_oRtsM",
            authDomain: "cricketduel.firebaseapp.com",
            databaseURL: "https://cricketduel-default-rtdb.firebaseio.com/",
            projectId: "cricketduel",
            storageBucket: "cricketduel.firebasestorage.app",
            messagingSenderId: "781919289708",
            appId: "1:781919289708:web:3c6076617f4b7813757349",
            measurementId: "G-HJC6PCGPEK"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);

        // --- MATRIX & CONSTANTS ---
        const MATRIX = {
            "6 RUNS": { "SPIN": {v:6, t:"Smashed!"}, "FULL TOSS": {v:6, t:"Punished!"}, "FAST": {v:"OUT", t:"Pace!"}, "YORKER": {v:"OUT", t:"Bowled!"}, "BOUNCER": {v:0, t:"Missed"} },
            "4 RUNS": { "BOUNCER": {v:4, t:"Pulled!"}, "FULL TOSS": {v:4, t:"Driven!"}, "FAST": {v:"OUT", t:"Edged!"}, "YORKER": {v:"OUT", t:"LBW!"}, "SPIN": {v:0, t:"Dot Ball"} },
            "2 RUNS": { "SPIN": {v:2, t:"Gap shot"}, "FAST": {v:2, t:"Guided"}, "BOUNCER": {v:"OUT", t:"Top Edge!"}, "YORKER": {v:"OUT", t:"Toe Crush!"}, "FULL TOSS": {v:0, t:"Dot Ball"} },
            "1 RUN":  { "FAST": {v:1, t:"Quick Single"}, "YORKER": {v:1, t:"Dug Out"}, "SPIN": {v:"OUT", t:"Stumped!"}, "BOUNCER": {v:"OUT", t:"Fended!"}, "FULL TOSS": {v:0, t:"Dot Ball"} },
            "DEFENSE":{ "FAST": {v:0, t:"Solid"}, "YORKER": {v:0, t:"Digs it out"}, "BOUNCER": {v:0, t:"Ducks"}, "SPIN": {v:0, t:"Blocked"}, "FULL TOSS": {v:"OUT", t:"Napping!"} }
        };
        const BAT_HAND = Object.keys(MATRIX);
        const BOWL_HAND = ["SPIN", "FAST", "YORKER", "BOUNCER", "FULL TOSS"];

        // --- STATE ---
        let room = "";
        let me = "";
        let myTeam = ""; 
        let isHost = false;
        let localData = null;

        const app = {
            join: () => {
                const c = document.getElementById('inp-room').value.toUpperCase().trim();
                const n = document.getElementById('inp-name').value.trim();
                if(!c || !n) return alert("Please enter Room Code & Name");
                room = c; me = n;

                const rRef = ref(db, `rooms/${room}`);
                get(rRef).then(snap => {
                    if(!snap.exists()) {
                        // NEW ROOM -> I AM HOST
                        isHost = true;
                        document.getElementById('force-btn').style.display = "block";
                        set(rRef, {
                            host: me,
                            state: "LOBBY",
                            players: { [me]: { team:"A", status:"ON" } },
                            teams: { A:{name:"Red", isNamed:false}, B:{name:"Blue", isNamed:false} },
                            score: { r:0, w:0, b:0, target:null },
                            turn: { striker: "", bowler: "", cBat: "", cBowl: "", result: "" }
                        });
                    } else {
                        // EXISTING ROOM
                        const val = snap.val();
                        if (val.host === me) {
                            isHost = true; // RECLAIM HOST
                            document.getElementById('force-btn').style.display = "block";
                        }
                        const p = val.players || {};
                        const t = Object.keys(p).length % 2 === 0 ? "A" : "B";
                        const existingTeam = p[me] ? p[me].team : t;
                        update(ref(db, `rooms/${room}/players/${me}`), { team: existingTeam, status:"ON" });
                    }
                    // Start Listener
                    onValue(rRef, s => { localData = s.val(); app.render(localData); if(isHost) app.hostLoop(localData); });
                });
            },

            render: (d) => {
                if(!d) return;
                
                // DETERMINE MY TEAM (Robust check)
                if(d.players && d.players[me]) myTeam = d.players[me].team;

                document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
                document.getElementById(`screen-${d.state.toLowerCase()}`).classList.add('active');

                // LOBBY
                if(d.state === "LOBBY") {
                    document.getElementById('lobby-code').innerText = room;
                    document.getElementById('host-badge').style.display = isHost ? 'block' : 'none';
                    document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';

                    const lA = document.getElementById('list-a');
                    const lB = document.getElementById('list-b');
                    lA.innerHTML = ""; lB.innerHTML = "";
                    
                    Object.entries(d.players||{}).forEach(([k,v]) => {
                        let ctrls = "";
                        if(isHost) {
                            const newT = v.team === "A" ? "B" : "A";
                            ctrls = `<div class="host-actions">
                                <button class="btn btn-mini" style="background:#f39c12" onclick="app.hostSetCap('${k}', '${v.team}')">¬©</button>
                                <button class="btn btn-mini" style="background:#7f8c8d" onclick="app.hostSwap('${k}', '${newT}')">‚áÑ</button>
                            </div>`;
                        }
                        const h = `<div class="player-item"><span>${k}</span> ${ctrls}</div>`;
                        if(v.team==="A") lA.innerHTML+=h; else lB.innerHTML+=h;
                    });
                    if(d.teams.A.captain) document.getElementById('cap-a-name').innerText = "‚≠ê " + d.teams.A.captain;
                    if(d.teams.B.captain) document.getElementById('cap-b-name').innerText = "‚≠ê " + d.teams.B.captain;
                }

                // NAMING
                if(d.state === "NAMING") {
                    const isCap = d.teams[myTeam].captain === me;
                    const ui = document.getElementById('naming-ui');
                    if(isCap && !d.teams[myTeam].isNamed) {
                        ui.style.display = "block";
                        document.getElementById('naming-msg').innerText = "Captain, name your team:";
                    } else {
                        ui.style.display = "none";
                        document.getElementById('naming-msg').innerText = "Waiting for captains...";
                    }
                }

                // TOSS
                if(d.state === "TOSS") {
                    const t = d.toss;
                    const coin = document.getElementById('coin');
                    const ui = document.getElementById('toss-ui');
                    const msg = document.getElementById('toss-msg');
                    
                    coin.className = t.step==="SPIN" ? "spinning" : "";
                    coin.innerText = t.step==="DECIDE" ? (t.call==="HEADS"?"H":"T") : "?";
                    ui.innerHTML = "";

                    if(t.step === "CALL" && myTeam === "A" && d.teams.A.captain === me) {
                        msg.innerText = "Call HEADS or TAILS";
                        ui.innerHTML = `<button class="btn" onclick="app.tossCall('HEADS')">HEADS</button> <button class="btn" onclick="app.tossCall('TAILS')">TAILS</button>`;
                    } else if (t.step === "DECIDE" && t.winner === myTeam && d.teams[myTeam].captain === me) {
                        msg.innerText = "YOU WON! Choose:";
                        ui.innerHTML = `<button class="btn" onclick="app.tossDecide('BAT')">BAT</button> <button class="btn" onclick="app.tossDecide('BOWL')">BOWL</button>`;
                    } else {
                        msg.innerText = t.step==="SPIN"?"Coin Spinning...":"Waiting for Toss...";
                    }
                }

                // SELECTION
                if(d.state === "SELECTION") {
                    const isBat = d.batTeam === myTeam;
                    const isCap = d.teams[myTeam].captain === me;
                    const role = isBat ? "Striker" : "Bowler";
                    
                    document.getElementById('sel-title').innerText = `Pick a ${role}`;
                    const list = document.getElementById('sel-list');
                    list.innerHTML = "";

                    const picked = isBat ? d.turn?.striker : d.turn?.bowler;

                    if(picked) {
                        document.getElementById('sel-msg').innerText = `${role} Selected: ${picked}`;
                        // If I am just a player (not cap) I wait
                        if(!isCap) document.getElementById('sel-msg').innerText += " (Waiting for opponent)";
                    } else if(isCap) {
                        document.getElementById('sel-msg').innerText = "Tap a player to send to pitch:";
                        Object.entries(d.players).forEach(([k,v]) => {
                            if(v.team === myTeam) {
                                list.innerHTML += `<button class="btn" style="width:100%; margin-bottom:5px;" onclick="app.selectPlayer('${k}')">${k}</button>`;
                            }
                        });
                    } else {
                        document.getElementById('sel-msg').innerText = "Captain is selecting...";
                    }
                }

                // GAMEPLAY
                if(d.state === "GAME") {
                    document.getElementById('sb-bat').innerText = d.teams[d.batTeam].name;
                    document.getElementById('sb-bowl').innerText = d.teams[d.bowlTeam].name;
                    document.getElementById('sb-score').innerText = `${d.score.r}/${d.score.w}`;
                    document.getElementById('sb-overs').innerText = Math.floor(d.score.b/6) + "." + (d.score.b%6);

                    const turn = d.turn || {};
                    let role = "spec";
                    if(turn.striker === me) role = "bat";
                    if(turn.bowler === me) role = "bowl";

                    const foot = document.getElementById('foot-hand');
                    foot.innerHTML = "";
                    
                    // CARD GENERATION LOGIC
                    if(role === "bat") BAT_HAND.forEach(c => foot.innerHTML += `<button class="card-btn" onclick="app.play('${c}')">${c}</button>`);
                    else if(role === "bowl") BOWL_HAND.forEach(c => foot.innerHTML += `<button class="card-btn" onclick="app.play('${c}')">${c}</button>`);
                    else foot.innerHTML = "<p style='width:100%; text-align:center; color:#ccc'>Spectating...</p>";

                    const sMe = document.getElementById('slot-me');
                    const sOpp = document.getElementById('slot-opp');
                    sMe.className="slot"; sOpp.className="slot";

                    if(role !== "spec") {
                        const myC = role==="bat" ? turn.cBat : turn.cBowl;
                        if(myC) { sMe.classList.add('ready'); sMe.innerHTML=`<div style="font-size:1.1rem; font-weight:bold">${myC}</div>`; }
                        else sMe.innerHTML = "YOUR<br>MOVE";
                        
                        const opC = role==="bat" ? turn.cBowl : turn.cBat;
                        if(opC) { sOpp.classList.add('ready'); sOpp.innerHTML="READY"; }
                        else sOpp.innerHTML = "OPPONENT<br>THINKING";
                    } else {
                        sMe.innerHTML = turn.striker || "...";
                        sOpp.innerHTML = turn.bowler || "...";
                    }

                    if(turn.result) {
                        const res = document.getElementById('result-overlay');
                        res.style.display = "flex";
                        document.getElementById('res-text').innerText = turn.result;
                        document.getElementById('res-desc').innerText = turn.desc;
                        
                        if(role !== "spec") {
                            const opC = role==="bat" ? turn.cBowl : turn.cBat;
                            sOpp.classList.add('revealed');
                            sOpp.innerText = opC;
                        }
                    } else {
                        document.getElementById('result-overlay').style.display = "none";
                    }
                }
            },

            // --- HOST ONLY ACTIONS ---
            hostSwap: (pName, newTeam) => {
                update(ref(db, `rooms/${room}/players/${pName}`), { team: newTeam });
                if(localData.teams.A.captain === pName) update(ref(db, `rooms/${room}/teams/A/captain`), null);
                if(localData.teams.B.captain === pName) update(ref(db, `rooms/${room}/teams/B/captain`), null);
            },
            hostSetCap: (pName, t) => {
                update(ref(db, `rooms/${room}/teams/${t}/captain`), pName);
            },
            hostShuffle: () => {
                const players = Object.keys(localData.players);
                for (let i = players.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [players[i], players[j]] = [players[j], players[i]];
                }
                const updates = {};
                players.forEach((p, i) => { updates[`rooms/${room}/players/${p}/team`] = i % 2 === 0 ? "A" : "B"; });
                updates[`rooms/${room}/teams/A/captain`] = null;
                updates[`rooms/${room}/teams/B/captain`] = null;
                update(ref(db), updates);
            },
            hostStart: () => {
                if(!localData.teams.A.captain || !localData.teams.B.captain) return alert("Assign captains first!");
                update(ref(db, `rooms/${room}`), {state:"NAMING"});
            },

            // --- PLAYER ACTIONS ---
            submitName: () => {
                const n = document.getElementById('inp-teamname').value;
                update(ref(db, `rooms/${room}/teams/${myTeam}`), {name:n, isNamed:true});
            },
            tossCall: (c) => update(ref(db, `rooms/${room}/toss`), {call:c, step:"SPIN"}),
            tossDecide: (c) => {
                const l = myTeam==="A"?"B":"A";
                update(ref(db, `rooms/${room}`), {batTeam:myTeam, bowlTeam:l, state:"SELECTION"});
                update(ref(db, `rooms/${room}/turn`), {striker:"", bowler:"", cBat:"", cBowl:"", result:""});
            },
            
            selectPlayer: (p) => {
                // Determine which field I am filling based on MY TEAM, not Host data
                const isBat = localData.batTeam === myTeam;
                const field = isBat ? "striker" : "bowler";
                update(ref(db, `rooms/${room}/turn`), { [field]: p });
            },

            play: (c) => {
                // Determine if I am batting or bowling
                const isBat = localData.batTeam === myTeam;
                const field = isBat ? "cBat" : "cBowl";
                update(ref(db, `rooms/${room}/turn`), { [field]: c });
            },
            
            closeOverlay: () => {
                // If I am Host, I trigger the reset for everyone
                if(isHost) {
                     update(ref(db, `rooms/${room}`), { state:"SELECTION" });
                     update(ref(db, `rooms/${room}/turn`), { cBat:"", cBowl:"", result:"", desc:"", striker:null, bowler:null }); 
                }
            },

            // --- HOST SERVER LOOP (Background Logic) ---
            hostLoop: (d) => {
                if(!d) return;

                // Naming -> Toss
                if(d.state==="NAMING" && d.teams.A.isNamed && d.teams.B.isNamed) {
                    update(ref(db, `rooms/${room}`), {state:"TOSS", toss:{step:"CALL"}});
                }
                // Toss Spin
                if(d.state==="TOSS" && d.toss.step==="SPIN" && !d.toss.winner) {
                    setTimeout(() => {
                        const res = Math.random()>0.5?"HEADS":"TAILS";
                        const w = res===d.toss.call ? "A" : "B";
                        update(ref(db, `rooms/${room}/toss`), {winner:w, step:"DECIDE", call:res});
                    }, 2000);
                }
                
                // Selection -> Game (Wait for both)
                if(d.state==="SELECTION" && d.turn && d.turn.striker && d.turn.bowler) {
                    update(ref(db, `rooms/${room}`), {state:"GAME"});
                }

                // Game Logic
                if(d.state==="GAME" && d.turn && d.turn.cBat && d.turn.cBowl && !d.turn.result) {
                    const resObj = MATRIX[d.turn.cBat][d.turn.cBowl];
                    const sc = {...d.score};
                    sc.b++;
                    if(resObj.v === "OUT") sc.w++; else sc.r += resObj.v;
                    
                    update(ref(db, `rooms/${room}/turn`), {
                        result: (resObj.v==="OUT"?"OUT!":resObj.v+" RUNS"), 
                        desc: resObj.t
                    });
                    update(ref(db, `rooms/${room}/score`), sc);
                }

                // Force Button
                document.getElementById('force-btn').onclick = () => {
                    if(d.state === "NAMING") update(ref(db, `rooms/${room}`), { state: "TOSS", toss:{step:"CALL"}, teams:{A:{isNamed:true, name:"Red"}, B:{isNamed:true, name:"Blue"}} });
                    if(d.state === "TOSS") update(ref(db, `rooms/${room}`), { state: "SELECTION", batTeam:"A", bowlTeam:"B" });
                    if(d.state === "SELECTION") {
                        const p = Object.keys(d.players);
                        update(ref(db, `rooms/${room}/turn`), { striker:p[0], bowler:p[1] });
                    } 
                    if(d.state === "GAME") app.closeOverlay();
                }
            }
        };

        // Expose
        window.app = app;
    </script>
</body>
</html>