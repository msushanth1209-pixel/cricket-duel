<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricket Duel: Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#0f0f0f; --text:#fff; --gold:#ffcc00; --red:#e74c3c; --blue:#3498db; --green:#27ae60; --dark:#1a1a1a; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* --- HEADER BAR --- */
        .top-bar { 
            width: 100%; height: 60px; background: #111; border-bottom: 2px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 100;
        }
        .bar-btn {
            background: transparent; border: 1px solid #555; color: #aaa;
            padding: 5px 15px; font-family: 'Teko'; font-size: 1.2rem; cursor: pointer;
            border-radius: 4px; transition: 0.2s;
        }
        .bar-btn:active { background: var(--gold); color: black; border-color: var(--gold); }
        .status-text { font-family: 'Teko'; font-size: 1.5rem; color: var(--gold); letter-spacing: 1px; }

        /* --- SCREENS --- */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; position: relative; z-index: 10; overflow-y: auto; padding-bottom: 20px; }
        .screen.active { display: flex; }
        .hidden { display: none !important; }

        /* --- UI COMPONENTS --- */
        .container { width: 90%; max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        .btn { 
            border: none; padding: 12px; font-family: 'Teko'; font-size: 1.5rem; 
            cursor: pointer; text-transform: uppercase; width: 100%; border-radius: 6px;
            transition: transform 0.1s; display: block;
        }
        .btn:active { transform: scale(0.96); }
        .btn-gold { background: var(--gold); color: black; font-weight: bold; box-shadow: 0 4px 0 #b38f00; }
        .btn-blue { background: var(--blue); color: white; box-shadow: 0 4px 0 #217dbb; }
        .btn-red { background: var(--red); color: white; box-shadow: 0 4px 0 #c0392b; }
        
        .input-box { 
            background: #222; border: 2px solid #444; color: white; padding: 15px; 
            width: 100%; text-align: center; font-size: 1.3rem; border-radius: 8px; outline: none; 
            font-family: 'Rajdhani', sans-serif;
        }
        .input-box:focus { border-color: var(--gold); }

        /* --- LOBBY LISTS --- */
        .lobby-grid { display: flex; width: 100%; height: 100%; }
        .team-col { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .p-card { 
            background: #222; padding: 10px; border-radius: 4px; border-left: 5px solid #555;
            display: flex; justify-content: space-between; align-items: center; font-weight: bold;
        }
        .p-card.red { border-color: var(--red); }
        .p-card.blue { border-color: var(--blue); }
        .action-icon { font-size: 1.2rem; padding: 0 8px; cursor: pointer; opacity: 0.6; }
        .action-icon:hover { opacity: 1; transform: scale(1.2); }

        /* --- GAMEPLAY --- */
        .scoreboard {
            width: 100%; background: #151515; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; flex-shrink: 0;
        }
        .score-box { text-align: center; }
        .big-digit { font-family: 'Teko'; font-size: 2.2rem; line-height: 0.9; color: white; }
        .small-lbl { font-size: 0.8rem; color: #777; }

        .pitch { 
            flex: 1; width: 100%; background: var(--green); position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(255,255,255,0.1) 20px);
        }
        
        .card-slot { 
            width: 100px; height: 140px; border: 3px dashed rgba(255,255,255,0.3); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            margin: 15px; background: rgba(0,0,0,0.1); 
        }
        .card { 
            width: 100px; height: 140px; background: white; color: black; border-radius: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-family: 'Teko'; font-size: 1.8rem; border: 4px solid #333; 
            animation: popIn 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
        }
        .card-bat { border-color: var(--blue); background: linear-gradient(135deg, #fff, #e3f2fd); }
        .card-bowl { border-color: var(--red); background: linear-gradient(135deg, #fff, #ffebee); }

        .hand-scroll {
            width: 100%; height: 160px; background: #1a1a1a; border-top: 2px solid var(--gold);
            display: flex; align-items: center; gap: 10px; padding: 0 15px; overflow-x: auto; flex-shrink: 0;
        }

        /* --- RULES MODAL --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 2000; display:none; align-items:center; justify-content:center; }
        .modal-box { background: #222; padding: 20px; border: 2px solid var(--gold); width: 90%; max-width: 400px; border-radius: 10px; max-height: 85vh; overflow-y: auto; }
        .rule-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; font-size: 0.95rem; }

        @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }
    </style>
</head>
<body>

    <div class="top-bar">
        <button class="bar-btn" onclick="toggleRules()">RULES</button>
        <div id="status-display" class="status-text">LOBBY</div>
        <button class="bar-btn" onclick="exitGame()">EXIT</button>
    </div>

    <div id="rules-modal" class="modal-overlay" onclick="toggleRules()">
        <div class="modal-box">
            <h2 style="color:var(--gold); text-align:center; margin-bottom:15px;">GAME RULES</h2>
            <div class="rule-row"><b style="color:var(--blue)">6 RUNS</b> <span>beats Spin, FullToss</span></div>
            <div class="rule-row"><b style="color:var(--blue)">4 RUNS</b> <span>beats Bouncer, FullToss</span></div>
            <div class="rule-row"><b style="color:var(--blue)">2 RUNS</b> <span>beats Spin, Fast</span></div>
            <div class="rule-row"><b style="color:var(--blue)">1 RUN</b> <span>beats Yorker, Fast</span></div>
            <div class="rule-row"><b style="color:var(--blue)">DEFENSE</b> <span>Safe vs Pace/Yorker</span></div>
            <div class="rule-row"><b style="color:var(--red)">YORKER</b> <span>OUT vs 6, 4, 2</span></div>
            <p style="text-align:center; margin-top:20px; color:#666;">(Tap anywhere to close)</p>
        </div>
    </div>

    <div id="s-home" class="screen active" style="justify-content:center;">
        <div class="container" style="text-align:center;">
            <h1 style="font-size:5rem; color:var(--gold); font-family:'Teko'; line-height:0.8;">CRICKET<br>DUEL</h1>
            <p style="color:#777; letter-spacing:3px;">CHAMPIONSHIP</p>
            <br>
            <input type="text" id="my-name" class="input-box" placeholder="YOUR NAME" maxlength="10">
            <button class="btn btn-gold" onclick="createRoom()">HOST GAME</button>
            <div style="display:flex; width:100%; gap:10px;">
                <input type="text" id="join-code" class="input-box" placeholder="CODE" style="margin:0;">
                <button class="btn btn-outline" style="border:2px solid #555; background:none; color:#ccc;" onclick="joinRoom()">JOIN</button>
            </div>
        </div>
    </div>

    <div id="s-lobby" class="screen">
        <div style="text-align:center; padding:10px; background:#1a1a1a;">
            <span style="color:#555;">ROOM:</span> 
            <span id="disp-code" style="color:var(--gold); font-size:1.5rem; font-family:'Teko'; font-weight:bold;">...</span>
        </div>
        
        <div class="lobby-grid">
            <div class="team-col" style="border-right:1px solid #333;">
                <div style="text-align:center; color:var(--red); font-family:'Teko'; font-size:1.3rem;">RED TEAM</div>
                <div id="list-red"></div>
            </div>
            <div class="team-col">
                <div style="text-align:center; color:var(--blue); font-family:'Teko'; font-size:1.3rem;">BLUE TEAM</div>
                <div id="list-blue"></div>
            </div>
        </div>

        <div id="host-controls" class="hidden" style="background:#1a1a1a; padding:15px; border-top:2px solid var(--gold);">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button class="bar-btn" onclick="randomizeTeams()">SHUFFLE</button>
                <button class="bar-btn" onclick="randomizeCaptains()">AUTO CAP</button>
            </div>
            <div style="display:flex; gap:10px;">
                <select id="overs-select" class="input-box" style="margin:0; padding:10px; width:40%;">
                    <option value="1">1 OVR</option>
                    <option value="2">2 OVR</option>
                    <option value="5">5 OVR</option>
                </select>
                <button class="btn btn-gold" style="margin:0; width:60%;" onclick="startGame()">START</button>
            </div>
        </div>
        <div id="wait-msg" style="text-align:center; padding:20px; color:#555;">Waiting for Host...</div>
    </div>

    <div id="s-naming" class="screen" style="justify-content:center;">
        <div class="container" style="text-align:center;">
            <h2 id="name-timer" style="color:var(--gold); font-size:3rem; font-family:'Teko';">30</h2>
            
            <div id="naming-ui" class="hidden" style="width:100%;">
                <p style="color:var(--gold); font-size:1.2rem;">YOU ARE CAPTAIN!</p>
                <input type="text" id="team-name-in" class="input-box" placeholder="ENTER TEAM NAME">
                <button class="btn btn-gold" onclick="submitName()">SUBMIT</button>
            </div>
            
            <p id="naming-wait" style="color:#666;">Waiting for Captains...</p>
        </div>
    </div>

    <div id="s-toss" class="screen" style="justify-content:center;">
        <div class="container" style="text-align:center;">
            <h1 class="font-teko" style="font-size:4rem; color:var(--gold);">COIN TOSS</h1>
            <h2 id="toss-res" style="color:white;">FLIPPING...</h2>
            
            <div id="toss-ui" class="hidden" style="width:100%; margin-top:20px;">
                <p style="color:var(--gold);">YOU WON! CHOOSE:</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-blue" onclick="pickToss('BAT')">BAT</button>
                    <button class="btn btn-red" onclick="pickToss('BOWL')">BOWL</button>
                </div>
            </div>
            
            <p id="toss-wait" style="color:#666;">Waiting for Winner...</p>
        </div>
    </div>

    <div id="s-selection" class="screen">
        <div style="padding:15px; text-align:center; background:#1a1a1a;">
            <div id="sel-title" style="color:var(--gold); font-size:1.5rem; font-family:'Teko';">SELECT PLAYER</div>
        </div>
        <div id="sel-list" style="padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div id="s-game" class="screen">
        <div class="scoreboard">
            <div class="score-box" style="text-align:left;">
                <div id="bat-name" style="color:var(--blue); font-weight:bold;">BAT</div>
                <div id="score-disp" class="big-digit">0/0</div>
            </div>
            <div class="score-box">
                <div class="small-lbl" id="target-disp"></div>
                <div id="game-status" style="color:var(--gold); font-family:'Teko'; font-size:1.5rem;">PLAY</div>
            </div>
            <div class="score-box" style="text-align:right;">
                <div id="bowl-name" style="color:var(--red); font-weight:bold;">BOWL</div>
                <div id="overs-disp" class="big-digit">0.0</div>
            </div>
        </div>

        <div class="pitch">
            <div id="slot-opp" class="card-slot"><span style="color:#555;">OPP</span></div>
            <div style="width:60%; height:2px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
            <div id="slot-me" class="card-slot"><span style="color:#555;">YOU</span></div>
            
            <div id="result-pop" style="position:absolute; font-size:5rem; font-family:'Teko'; display:none; text-shadow:0 0 20px black; z-index:50;">OUT!</div>
        </div>

        <div id="hand-area" class="hand-scroll"></div>
        <div id="spec-msg" class="hidden" style="text-align:center; padding:20px; color:#666;">WATCHING...</div>
    </div>

    <div id="s-over" class="screen" style="justify-content:center; align-items:center;">
        <h1 style="color:var(--gold); font-size:4rem; font-family:'Teko';">MATCH OVER</h1>
        <h2 id="win-msg" style="margin-bottom:20px;">TEAM WINS</h2>
        <button class="btn btn-gold" style="width:auto;" onclick="location.reload()">MAIN MENU</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC--gCjpWdYsezrqvQ4tAzvtLKGW_oRtsM",
            authDomain: "cricketduel.firebaseapp.com",
            databaseURL: "https://cricketduel-default-rtdb.firebaseio.com/",
            projectId: "cricketduel",
            storageBucket: "cricketduel.firebasestorage.app",
            messagingSenderId: "781919289708",
            appId: "1:781919289708:web:3c6076617f4b7813757349"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CONSTANTS ---
        const CARDS = { BAT: ['6 RUNS','4 RUNS','4 RUNS','2 RUNS','2 RUNS','1 RUN','1 RUN','DEFENSE'], BOWL: ['YORKER','BOUNCER','FAST','FAST','SPIN','SPIN','FULL TOSS','FULL TOSS'] };
        const MATRIX = { '6 RUNS':{'FULL TOSS':6,'SPIN':6,'FAST':-1,'YORKER':-1,'BOUNCER':0}, '4 RUNS':{'FULL TOSS':4,'BOUNCER':4,'FAST':-1,'YORKER':-1,'SPIN':0}, '2 RUNS':{'SPIN':2,'FAST':2,'BOUNCER':-1,'YORKER':-1,'FULL TOSS':0}, '1 RUN':{'FAST':1,'YORKER':1,'SPIN':-1,'BOUNCER':-1,'FULL TOSS':0}, 'DEFENSE':{'FAST':0,'YORKER':0,'FULL TOSS':-1,'SPIN':0,'BOUNCER':0} };

        // --- STATE ---
        let myName = sessionStorage.getItem('cd_name') || "", roomCode = sessionStorage.getItem('cd_room') || "", isHost = false, myTeam = "A";
        let localState = null, lastBall = -1;

        // --- GLOBAL BINDINGS ---
        window.toggleRules = () => { const el = document.getElementById('rules-modal'); el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; };
        const $ = id => document.getElementById(id);
        const show = id => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); };

        // --- SETUP ---
        window.createRoom = async () => {
            myName = $('my-name').value.toUpperCase(); if(!myName) return alert("Name?");
            roomCode = Math.random().toString(36).substring(2,6).toUpperCase(); isHost = true;
            sessionStorage.setItem('cd_name', myName); sessionStorage.setItem('cd_room', roomCode);
            await set(ref(db, 'rooms/'+roomCode), { state: 'LOBBY', players: {[myName]:{team:'A',hand:[]}}, teams:{A:{name:'RED TEAM'},B:{name:'BLUE TEAM'}}, score:{r:0,w:0,b:0} });
            init();
        };
        window.joinRoom = async () => {
            myName = $('my-name').value.toUpperCase(); roomCode = $('join-code').value.toUpperCase(); if(!myName||!roomCode) return alert("Info?");
            if(!(await get(ref(db, 'rooms/'+roomCode))).exists()) return alert("No Room");
            sessionStorage.setItem('cd_name', myName); sessionStorage.setItem('cd_room', roomCode);
            const snap = await get(ref(db, 'rooms/'+roomCode));
            const pCount = Object.keys(snap.val().players||{}).length;
            await update(ref(db, `rooms/${roomCode}/players/${myName}`), { team: pCount%2===0?'A':'B' });
            init();
        };

        function init() {
            $('disp-code').innerText = roomCode;
            onValue(ref(db, 'rooms/'+roomCode), snap => { localState = snap.val(); if(localState) render(localState); else location.reload(); });
            if(isHost) setInterval(hostLoop, 1000);
        }

        // --- HOST SERVER LOOP ---
        function hostLoop() {
            if(!localState || !localState.timerEnd) return;
            const left = localState.timerEnd - Math.floor(Date.now()/1000);
            
            // Auto Naming Force
            if(localState.state === 'NAMING' && left <= 0) {
                update(ref(db, `rooms/${roomCode}/state`), 'TOSS');
            }
            // Auto Game Force
            if(localState.state === 'SELECTION' && left <= 0) window.forceSel();
            if(localState.state === 'GAME' && left <= 0) window.forceGame();
        }

        function render(data) {
            $('status-display').innerText = data.state;
            if(data.players && data.players[myName]) myTeam = data.players[myName].team;
            
            if(data.state === 'LOBBY') renderLobby(data);
            else if(data.state === 'NAMING') renderNaming(data);
            else if(data.state === 'TOSS') renderToss(data);
            else if(data.state === 'SELECTION') renderSel(data);
            else if(data.state === 'GAME') renderGame(data);
            else if(data.state === 'OVER') { show('s-over'); $('win-msg').innerText = (data.winner==='A'?data.teams.A.name:data.teams.B.name)+" WINS!"; }
        }

        // 1. LOBBY
        function renderLobby(data) {
            show('s-lobby');
            $('list-red').innerHTML = ''; $('list-blue').innerHTML = '';
            Object.keys(data.players).forEach(p => {
                const tm = data.players[p].team;
                const isCap = data.teams[tm].captain === p;
                const div = document.createElement('div');
                div.className = `p-card ${tm==='A'?'red':'blue'}`;
                div.innerHTML = `<span>${p} ${isCap?'ðŸ‘‘':''}</span>` + (isHost ? `<div><span class="action-icon" onclick="swap('${p}','${tm}')">â‡„</span><span class="action-icon" onclick="setCap('${p}','${tm}')">ðŸ‘‘</span></div>` : '');
                (tm==='A'?$('list-red'):$('list-blue')).appendChild(div);
            });
            if(isHost) { $('host-controls').classList.remove('hidden'); $('wait-msg').classList.add('hidden'); }
        }
        
        // Window functions for HTML onclicks
        window.swap = (p,t) => update(ref(db, `rooms/${roomCode}/players/${p}/team`), t==='A'?'B':'A');
        window.setCap = (p,t) => update(ref(db, `rooms/${roomCode}/teams/${t}/captain`), p);
        window.randomizeTeams = () => { /* Logic omitted for brevity, manual swap available */ };
        window.randomizeCaptains = () => {
            const p = localState.players;
            const tA = Object.keys(p).filter(k=>p[k].team==='A');
            const tB = Object.keys(p).filter(k=>p[k].team==='B');
            let up = {};
            if(tA.length) up['teams/A/captain'] = tA[Math.floor(Math.random()*tA.length)];
            if(tB.length) up['teams/B/captain'] = tB[Math.floor(Math.random()*tB.length)];
            update(ref(db, `rooms/${roomCode}`), up);
        };
        
        window.startGame = () => {
            const p = localState.players;
            const tA = Object.keys(p).filter(k=>p[k].team==='A');
            const tB = Object.keys(p).filter(k=>p[k].team==='B');
            let up = { state: 'NAMING', overs: parseInt($('overs-select').value), timerEnd: Math.floor(Date.now()/1000)+30 };
            if(!localState.teams.A.captain && tA.length) up['teams/A/captain'] = tA[Math.floor(Math.random()*tA.length)];
            if(!localState.teams.B.captain && tB.length) up['teams/B/captain'] = tB[Math.floor(Math.random()*tB.length)];
            update(ref(db, 'rooms/'+roomCode), up);
        };

        // 2. NAMING
        function renderNaming(data) {
            show('s-naming');
            const left = Math.max(0, data.timerEnd - Math.floor(Date.now()/1000));
            $('name-timer').innerText = left;
            
            const isCap = data.teams[myTeam].captain === myName;
            if(isCap && !data.teams[myTeam].isNamed) { 
                $('naming-ui').classList.remove('hidden'); 
                $('naming-wait').classList.add('hidden');
            } else { 
                $('naming-ui').classList.add('hidden'); 
                $('naming-wait').classList.remove('hidden');
            }
            if(isHost && data.teams.A.isNamed && data.teams.B.isNamed) update(ref(db, `rooms/${roomCode}/state`), 'TOSS');
        }
        window.submitName = () => {
            const n = $('team-name-in').value.toUpperCase(); if(!n) return;
            let up = {}; up[`teams/${myTeam}/name`]=n; up[`teams/${myTeam}/isNamed`]=true;
            update(ref(db, 'rooms/'+roomCode), up);
        };

        // 3. TOSS
        function renderToss(data) {
            show('s-toss');
            if(isHost && !data.tossWinner) setTimeout(() => update(ref(db, `rooms/${roomCode}/tossWinner`), Math.random()>0.5?'A':'B'), 1500);

            if(data.tossWinner) {
                $('toss-res').innerText = data.teams[data.tossWinner].name + " WON!";
                const isCap = data.teams[myTeam].captain === myName;
                if(isCap && data.tossWinner === myTeam) { 
                    $('toss-ui').classList.remove('hidden'); 
                    $('toss-wait').classList.add('hidden');
                } else { 
                    $('toss-ui').classList.add('hidden'); 
                    $('toss-wait').classList.remove('hidden');
                }
            }
        }
        window.pickToss = (c) => update(ref(db, 'rooms/'+roomCode), { state: 'SELECTION', batTeam: (c==='BAT'?localState.tossWinner:(localState.tossWinner==='A'?'B':'A')), bowlTeam: (c==='BAT'?(localState.tossWinner==='A'?'B':'A'):localState.tossWinner) });

        // 4. SELECTION
        function renderSel(data) {
            show('s-selection');
            const isBat = data.batTeam === myTeam;
            const isCap = data.teams[myTeam].captain === myName;
            $('sel-title').innerText = isCap ? `PICK ${isBat?'BATTER':'BOWLER'}` : "WAITING FOR CAPTAIN";
            $('sel-list').innerHTML = '';
            
            if(isCap) {
                Object.keys(data.players).forEach(p => {
                    if(data.players[p].team === myTeam) {
                        const b = document.createElement('button'); b.className = "btn btn-outline"; b.innerText = p; b.style.marginBottom="10px";
                        b.onclick = () => update(ref(db, `rooms/${roomCode}/turn/${isBat?'striker':'bowler'}`), p);
                        $('sel-list').appendChild(b);
                    }
                });
            }
            if(isHost && data.turn?.striker && data.turn?.bowler) {
                let up = { state: 'GAME', timerEnd: Math.floor(Date.now()/1000)+25 };
                up[`players/${data.turn.striker}/hand`] = CARDS.BAT;
                up[`players/${data.turn.bowler}/hand`] = CARDS.BOWL;
                update(ref(db, 'rooms/'+roomCode), up);
            }
        }
        window.forceSel = () => {
            const getR = (t) => { const k=Object.keys(localState.players).filter(k=>localState.players[k].team===t); return k[Math.floor(Math.random()*k.length)]; };
            let up={}; if(!localState.turn?.striker) up['turn/striker']=getR(localState.batTeam); if(!localState.turn?.bowler) up['turn/bowler']=getR(localState.bowlTeam);
            update(ref(db, `rooms/${roomCode}`), up);
        };

        // 5. GAME
        function renderGame(data) {
            show('s-game');
            const bt = data.teams[data.batTeam].name; const bl = data.teams[data.bowlTeam].name;
            $('bat-name').innerText = bt; $('bowl-name').innerText = bl;
            $('score-disp').innerText = `${data.score.r}/${data.score.w}`;
            $('overs-disp').innerText = `${Math.floor(data.score.b/6)}.${data.score.b%6}`;
            if(data.score.target) $('target-disp').innerText = `TARGET: ${data.score.target}`;
            
            const s = data.turn.striker; const b = data.turn.bowler;
            const amStriker = myName === s; const amBowler = myName === b;
            
            if(!amStriker && !amBowler) {
                $('hand-area').classList.add('hidden'); $('spec-msg').classList.remove('hidden'); $('spec-msg').innerText = `${s} vs ${b}`;
            } else {
                $('spec-msg').classList.add('hidden'); $('hand-area').classList.remove('hidden');
                renderHand(data.players[myName].hand, amStriker);
            }

            const myC = amStriker ? data.turn.cBat : data.turn.cBowl;
            const oppC = amStriker ? data.turn.cBowl : data.turn.cBat;
            if(myC) $('slot-me').innerHTML = `<div class="card ${amStriker?'card-bat':'card-bowl'}">${myC}</div>`; else $('slot-me').innerHTML = '<span style="color:#777">PICK</span>';
            if(oppC) $('slot-opp').innerHTML = `<div class="card" style="background:#333; border-color:#555;">?</div>`; else $('slot-opp').innerHTML = '<span style="color:#777">WAITING</span>';

            if(data.turn.result && data.score.b !== lastBall) {
                lastBall = data.score.b;
                $('result-pop').style.display='block'; $('result-pop').innerText=data.turn.result;
                $('result-pop').style.color = data.turn.result==='OUT!'?'var(--red)':'var(--gold)';
                $('slot-opp').innerHTML = `<div class="card ${amStriker?'card-bowl':'card-bat'}">${oppC}</div>`; // Reveal
                setTimeout(()=>{ $('result-pop').style.display='none'; if(isHost) nextBall(); }, 2500);
            }
        }

        function renderHand(h, isBat) {
            const d = $('hand-area'); d.innerHTML = '';
            if(!h) return;
            h.forEach(c => {
                const div = document.createElement('div'); div.className = `card ${isBat?'card-bat':'card-bowl'}`;
                div.style.minWidth='80px'; div.style.height='110px'; div.style.fontSize='1.2rem'; div.innerText = c;
                div.onclick = () => update(ref(db, `rooms/${roomCode}/turn/${isBat?'cBat':'cBowl'}`), c);
                d.appendChild(div);
            });
        }

        // Host Logic Game Loop
        setInterval(() => {
            if(!isHost || !localState || localState.state !== 'GAME') return;
            const t = localState.turn;
            if(t && t.cBat && t.cBowl && !t.result) {
                const res = MATRIX[t.cBat][t.cBowl];
                let sc = localState.score; let txt = "";
                if(res === -1) { sc.w++; txt="OUT!"; } else { sc.r += res; txt=res+" RUNS"; }
                update(ref(db, `rooms/${roomCode}`), { score: sc, 'turn/result': txt });
            }
        }, 500);

        function nextBall() {
            let sc = localState.score; sc.b++;
            if(sc.w >= 10 || sc.b >= localState.overs*6) {
                if(sc.target) update(ref(db, `rooms/${roomCode}`), { state: 'OVER', winner: localState.bowlTeam });
                else update(ref(db, `rooms/${roomCode}`), { state: 'SELECTION', batTeam: localState.bowlTeam, bowlTeam: localState.batTeam, 'score/r':0,'score/w':0,'score/b':0,'score/target':sc.r, turn:{striker:null} });
            } else {
                let up = { 'score/b': sc.b, 'turn/cBat':null, 'turn/cBowl':null, 'turn/result':null };
                if(localState.turn.result==='OUT!' || sc.b%6===0) up.state = 'SELECTION';
                if(localState.turn.result==='OUT!') up['turn/striker']=null;
                if(sc.b%6===0) up['turn/bowler']=null;
                remCard(localState.turn.striker, localState.turn.cBat); remCard(localState.turn.bowler, localState.turn.cBowl);
                update(ref(db, `rooms/${roomCode}`), up);
            }
        }
        function remCard(p,c){ const h=localState.players[p].hand; const i=h.indexOf(c); if(i>-1) { h.splice(i,1); update(ref(db,`rooms/${roomCode}/players/${p}/hand`), h.length?h:CARDS[localState.batTeam==='A'?'BAT':'BOWL']); } }
        
        window.forceGame = () => { let up={}; if(!localState.turn.cBat) up['turn/cBat']=CARDS.BAT[0]; if(!localState.turn.cBowl) up['turn/cBowl']=CARDS.BOWL[0]; update(ref(db, `rooms/${roomCode}`), up); };
        window.exitGame = async () => { if(confirm("Exit?")) { await remove(ref(db, `rooms/${roomCode}/players/${myName}`)); location.reload(); } };

    </script>
</body>
</html>